---
marp: true
title: SIMDεα®κ΅Ίξ¦ΌεΆρφΆλυ°εα®κ°ήκ£ζΎ‹
theme: default
paginate: true
style: |
  section {
    justify-content: start;
    background-color: white;
    padding: 0px;
    background: linear-gradient(180deg,#E7FFE7 10%, #008080 10%,#008080 10.5%, white 10.5%, white 100%);
  }
  section h1 {
    margin-bottom: 0px;
    margine: 0px;
    padding-left: 10px;
    padding-top: 5px;
    padding-bottom: 3px;
    background-image: url(images/cybozulabs400.png);
    background-size: 15%;
    background-repeat: no-repeat;
    background-position: right 5px top 5px;
  }
  section.title {
    font-size: 200%;
    padding-left: 0px;
    padding-top: 0px;
    padding-bottom: 0px;
    background: linear-gradient(180deg,#E7FFE7 49%, #008080 49%,#008080 50%, white 50%, white 100%);
    text-align: center;
    justify-content: center;
  }
  section h2 {
    padding-left: 10px;
    padding-top: 0px;
    padding-bottom: 0px;
  }
  section h3 {
    padding-left: 30px;
    padding-top: 0px;
    padding-bottom: 0px;
  }
  section ul {
    margin: 0px;
  }
  section::after {
   font-size: 70%;
   content: attr(data-marpit-pagination) " / " attr(data-marpit-pagination-total);
  }
  table {margin-left: auto;margin-right: auto;table-layout: fixed;width: 90%;display:table;}
  thead th {text-align: center !important;}
  thead tr {background: #eaeaea;}
  tbody tr:nth-child(2n+1) {text-align: center !important;background: #fff;}
  tbody tr:nth-child(2n) {text-align: center !important;background: #eeeeee;}
  section .emp { color: red; }
  section pre {
    margin-bottom: 0px;
  }
---
<!--
headingDivider: 1
-->

<!--
_class: title
-->
# SIMDεα®κ΅Ίξ¦ΌεΆρφΆλυ°εα®κ°ήκ£ζΎ‹
<br>
<br>
εβµεβ¤εγΨε¤¨εβΊεγ»εγ©εγ ιε²θ―πμ½¶ιΘ΅
<br>
π°ι®Ξι§Βη­¦λκ€π£Ζι²»π­ΛΆώΎ2023ώΎ‰ 2023/6/29

# μ¨¤κ¦
## νϋ®μ®΅
1. ογΈθ±
1. οηθΏΨε¤¤εβ»εγ³εγΜε¦«
1. SIMD
1. x64 CPU
1. εγ¬εβ¤εγ¬ε¦µεβ·εα¨εβΉεγ«εγΌεγΞε¥γεγ
1. FMA
1. exp(x)
1. log(x)
1. εγάε¤»εβ―εγ¬εβΈεβΉεβΏ

# ογΈθ±
## ιδεβΈεΆ΅εγ©εβ¤εγΜε¦«εγεβ¨ε¥δεγΌεγ«εα―μ΄Άκ³±εα¤ε£λ
- εβΎε΅φεβΎε΅φοηιθ¬εΆ©ρφ¶ιΌεαε£λκΑκ¦ΆεΆ±εαεα„
  - ![width:500px](images/20230607-163615.png)
  - [π£Έη―χπ°ι®ΞεΆ­εα΄ε΅ρεβ¶λ«Πλ€ήε¤¤εγ«εβ΄εγεβΊεγ ώΎΑΎ(https://www.docswell.com/s/2300203199/ZQ81DV-2023-05-22-102059#p20)εβ°ε£κκΎΚιΘ
- εαΈε€Άε΅ύεβΈε£ιεα®εβ³εγΌεγ²ε΅μεβΆεβ»εγ³εγΜε¦¬π€π¬άρΌ°ζ»¥θΊµΆSMώΎ²εΆ©πΠκΏ°εαΚε£μεβ¶ε΅σεα¨εαΈη¤Τε΅δεα®εβ¤ζΊ¶η®
  - κ²¬θΪ§εΰΆε£βεαΞε΅λεαΞεΆ΅εβ²κ®¬ιθ¬ε΅μρφ¶ιΌεα«ρφΆεβΎε£λεα¶ε£βεαΞε£μεαεα„
  - ASM/SIMDώΎ°ι²»εα«x64εα®AVX-512ώΎ²ε£ςξ¶Ήθ½¶ε΅ωεβ‹

# οηθΏΨε¤¤εβ»εγ³εγΜε¦«
## [xbyak](https://github.com/herumi/xbyak) : x64ντ¨εα®ιλΚιΣδεαεβ³εγΌεγ²ε£ςντήθ―πεαε£λC++εγ©εβ¤εγΜε¦«εγ
  - Intel [oneAPI(oneDNN)](https://github.com/oneapi-src/oneDNN)εα®CPUεβ¨εγ³εβΈεγ³εα§ιθ©ντ¨εαΚε£μεα¦εα¨ε£λ
  - oneDNNεα―PyTorchεβ§µensorFlowεαεα©εα®Intelνι°εΆ©θΏΏεβΎε£μεα¦εα¨ε£λ
  - [εγΆε¥γεγΞε¦®εγ¦ε¥θεα«εαεα£εαήε€Έι¬¬4θΊΜζ»£Xeon SPεΰΊε€Άθ€§ογ½ιπΒζΈ΄εΆ°ρνµεα―AMXεα¨4εα¤εα®εβΆεβ―εβ»εγ©εγ¬εγΌεβΏ](https://pc.watch.impress.co.jp/docs/column/ubiq/1469146.html)
  ![width:380px](https://asset.watch.impress.co.jp/img/pcw/docs/1469/146/011_o.jpg) pc.watch.impress.co.jpεβ°ε£κκΎΚιΘ
  - εβΉεγΌεγΒε¦Ύεβ³εγ³εγΘε¦§εγΌεβΏκ±Έη²³ντ¨εα®[xbyak_aarch64](https://github.com/fujitsu/xbyak_aarch64)εβ¤ε΅βεβ‹
## [s_xbyak](https://github.com/herumi/s_xbyak) : Pythonεα§xbyakεγ©εβ¤εβ―εαπΠκΏ°εαΈεΆ©εαΊε£λx64ντ¨εα®ρύιΣδεαεβΆεβ»εγ³εγΜε¦«
  - θ½΄ηΥώεα―εαΖεΆ£εβ²ε΅μεγ΅εβ¤εγ³εΰ¤κ©³ξ¶°εα―[Xbyakεγ©εβ¤εβ―εαx64ντ¨ρύιΣδASMντήθ―πεγ¨ε¦Ύεγ«s_xbyak](https://zenn.dev/herumi/articles/s_xbyak-assembler-1)
# SIMD
## θΊ€εα¤εα®ιρ½θ½¤εα§π¦®θΚ²εα®εγ®ε¦ΎεβΏεβΔηΏμλω¤εΆ­ιη¦νπ¬ε΅ωεβ‹
- AVX-512εα―512εγΖε¥γεγ°εΆ°ZMMεγ¬εβΈεβΉεβΏεβ’32ιΰ¶θ·αεα¤
  zmm0, zmm1, ..., zmm31
- λυ΄λυ°ιώ‹
  - 8εγΖε¥γεγ°ε£ς64ιΰ‹, 16εγΖε¥γεγ°ε£ς32ιΰ‹, 32εγΖε¥γεγ°ε£ς16ιΰ‹, 64εγΖε¥γεγ°ε£ς8ιΰ¶θ²³εα°ε£λ
- μ·®ιλΚη°ΎθΚ²νβΉλυ°ιώ‹
  - 32εγΖε¥γεγ(float)εβ’16ιΰ‹, 64εγΖε¥γεγ(double)εβ’8ιΰ¶θ²³εα°ε£λ
  - Sapphire Rapidsεβ§¨ranite Rapidsεα―θΊ€ργ¨16εγΖε¥γεγ°ε£ς32ιΰ¶εΆεαΞεΆ¨λι±εα¬ηΒΏθ½¤εβ¤ε¤·εγΪε¦Ύεγ
    - [Granite Rapids/Sierra Forestεα®AMX/AVXεα®λφ°ιρ½θ½¤](https://zenn.dev/herumi/articles/granite-rapids-sierra-forest)
## κ΅Ίλό¬εα®κΏΆ
- op z, x, y # opεα―ιρ½θ½¤, z, x, yεα―εγ¬εβΈεβΉεβΏεβ¨ε¦£εγΆεγεβΔθ·ηεα™
- z γζ op(x, y) # xεα¨yεα®opεα®ξ·ΐθΫόεβΓΫεα«θ½£ιε¥εαε£λ
# floatιώ¶εΆ°ικ ξ°—
## vaddps(z, x, y)
- z, x, yεα―ZMMεγ¬εβΈεβΉεβΏ
- xεα®iνυνϋ®εα®floatιώ¶εΆ°π¨Άι΄ εβ’ $x_i$ εα¨εαε£λ
- $z_i = x_i + y_i$ for $i = 0, \dots, 15$
- psεα―packed single precision(float)εα®λδΎηΒµ

x|$x_0$|$x_1$|$x_2$|...|$x_{15}$
-|-|-|-|-|-
+|+|+|+|...|+
y|$y_0$|$y_1$|$y_2$|...|$y_{15}$
=|=|=|=|...|=
z|$z_0$|$z_1$|$z_2$|...|$z_{15}$

# μΉ»εα°η­ΞεΆ°ξ®ς£
## μ·®ιλΚη°ΎθΚ²νβΉλυ°ιώ‹
  - v+ιρ½θ½¤+{pd, ps}
  - ps : float
  - pd : double (double precision)
## λυ΄λυ°ιώ‹
  - vp + ιρ½θ½¤ + {b, w, d, q}
  - b : byte (8εγΖε¥γεγ°θΚ¶λυ°)
  - w : word (16εγΖε¥γεγ°θΚ¶λυ°)
  - d : dword (32εγΖε¥γεγ°θΚ¶λυ°)
  - q : qword (64εγΖε¥γεγ°θΚ¶λυ°)

# SIMDεβΔζ½Ώεα†
## ρεΊη―χιπΈη£«εα®ικ ξ°ΞλΜ¤λυ°
```cpp
void addc(float *z, const float *x, const float *y, size_t n) {
  for (size_t i = 0; i < n; i++) {
    z[i] = x[i] + y[i];
  }
}
```
## ξ²΅ινΠεΆ­εαε£λεαήε£αεα®θ½®κ°
- nεα―μ―£εα§16εα®ιΰΊθΚ²εα¨εαε£λ
- x[0..n], y[0..n], z[0..n]εα―θΌΔε΅δεα«εβεγΌεγΐε¦Ύεγ©εγ¦ε¥χεαΞεΆ¨εα¨εΆ¬εα„
  - restrictεα¨εαε£λ
- 64εγΐε¤¦εγ°ηΆ¦ιΙμεα«εβΆεγ©εβ¤εγ³εαΚε£μεα¦εα¨ε£λώΎ°ε΅σεα¨εαΈθΧϋεαΎεαΞε΅δώΎ‰

# SIMD(AVX-512)εα§εα®κ°ήκ£ζΎ‹
## s_xbyakεα«εβ°ε£λκ°ήκ£ζΎ‹
```python
with FuncProc('add_avx512'): # add_avx512εα¨εα¨ε΅ζρφΆλυ°εβΔζ½Ψε£λ
  with StackFrame(4, vNum=1, vType=T_ZMM) as sf: # ρφΆλυ°εα®κΎΚθΚ²εα―4ιΰ‹. ZMMεγ¬εβΈεβΉεβΏεβ’1ιΰ¶ζ½Ώεα†
    pz = sf.p[0] # 1νυνϋ®εα®κΎΚθΚ²εα―zεαΈεα®εγΪε¤¦εγ³εβΏώΎ°ε£ςξ¦Ίεαε¦®εβΈεβΉεβΏώΎ‰
    px = sf.p[1] # 2νυνϋ®εα®κΎΚθΚ²εα―xεαΈεα®εγΪε¤¦εγ³εβΏ
    py = sf.p[2] # 3νυνϋ®εα®κΎΚθΚ²εα―yεαΈεα®εγΪε¤¦εγ³εβΏ
    n = sf.p[3]  # 4νυνϋ®εα®κΎΚθΚ²εα―n
    lpL = Label() # εγ«εγΌεγΞιΘεγ©εγε¦­

    L(lpL) # εγ«εγΌεγΞιΘεγ©εγε¦­εα®κ°ΤιΎ©
    vmovups(zmm0, ptr(px)) # zmm0 = *px
    vaddps(zmm0, zmm0, ptr(py)) # zmm0 += *py as float
    vmovups(ptr(pz), zmm0) # *pz = zmm0
    add(px, 64) # px += 64
    add(py, 64) # py += 64
    add(pz, 64) # pz += 64
    sub(n, 16) # n -= 16
    jnz(lpL) # n != 0 εαεβ±ΝpLεα«λθ»εα£εα¦ξ»°εβ΄κΏΘε΅ω
```
# x64 CPUεα®κ΅Ίξ¦
## μ³ΌιΘεγ¬εβΈεβΉεβΏ
- 64εγΖε¥γεγ°θΚ¶λυ° : rax, rbx, rcx, rdx, rsi, rdi, rbp, r8-r15
- 32εγΖε¥γεγ°θΚ¶λυ° : eax, ebx, ecx, edx, esi, edi, ebp, r8d-r15d
  - 64εγΖε¥γεγ°ε¦®εβΈεβΉεβΏεα®θΊ¶ζ½32εγΖε¥γεγ°ε£ςθΏΏεα†
```
|63        32|31  16|15  8|7   0|
|           rax                 |
|            |     eax          |
|            |      |   ax      |
|            |      | ah | al   |
```
- εβΉεβΏεγ¦ε¤±εγ¬εβΈεβΉεβΏ : rspώΎ°ε¦―εγΌεβ«εγ«κ¦²θΚ²εαεα©θΑΪθ·αεαε£λεβΉεβΏεγ¦ε¤±ςΆΠηή΅εβΔθ·ηεαρΌ‰
## εαΪεΆ°θ½ΜεΆ°εγ¬εβΈεβΉεβΏ
- εγΚε¦«εβ°εγ¬εβΈεβΉεβΏEFLAGSώΎ―Δmpεαεα©εα®μ±ΘκΌ¦ιµΐθΫόεαΈη§εβ¶ε¦®εβΈεβΉεβΏ - κΐΈκΏ°ώΎ‰
- μ·®ιλΚη°ΎθΚ²νβΉλυ°ιώ¶εΆ°FPUεβ¤ε΅βεβ¶ε΅μνυ¥

# κ΅Ίλό¬ιρ½θ½¤
## Intel ASMεα®κ΅Ίλό¬εα®κΏΆ
- op x, y # x γζ op(x, y)
  - xεβ§Ϊεα―εγ¬εβΈεβΉεβΏεβ¨ε¦£εγΆεγεβΔθ·ηεα™
  - xεα¨yεα®opεα®λσΊζ½ΨιµΐθΫόεα·Ωεα«θ½£ιε¥εαΚε£μεβ‹
## mov x, y # x γζ y
- mov(x, ptr(y)) εα― `x = *(uint64_t*)y;`εα®λδΎηΒµώΎ―Ωεα64εγΖε¥γεγ°εΆ°κΆ΄ιπ°ρΌ‰
- xεα·΄IMDεγ¬εβΈεβΉεβΏεα®εα¨εαΊεΆ±movupsεαεα©εβΔζ½Ώεα†
## ξ°Ξκ΅ΖθΌΘι®—(add, sub, ...)εβ¨κ«ΜιΏζμΎΘι®—(and, xor, or, ...)
- add x, y # x γζ x + y
- and x, y # x γζ x & y
# λύ΅θ½¶ιθ¬η²
## μ±ΘκΌƒ : cmp x, y
- x - yεα®ξ·ΐθΫόεβΓ¦FLAGSεα«εβ»εγ¦ε¥θεαε£λεαΈθΌΘι®ΞιµΐθΫόεα―xεα«ιοΊθΠΆεαΞεΆ¬εα„
  - ZF(Zero Flag) : x == yεαεβ‰1
  - CF(Carry Flag) : x < yεαεβ‰1 (unsigned)
- cf. sub x, yεα―μΎΘι®ΞιµΐθΫόεα·Ωεα«ιοΊθΠΆεαΚε£μεβ¶ρΌ―Ω γζ x - yώΎ‰
## εγ¬ε¤»εγ : test x, y
- x & yεα®ξ·ΐθΫόεβΓ¦FLAGSεα«εβ»εγ¦ε¥θεαε£λεαΈθΌΘι®ΞιµΐθΫόεα―xεα«ιοΊθΠΆεαΚε£μεαεα„
  - ZF : x & y == 0εαεβ‰1
- and x, yεα―ιπΈε΅ψιΰ¤εβΓ¦FLAGSεα«εβ»εγ¦ε¥θεαΞεΆ¨xεα«ιοΊθΠΆεαΚε£μεβ¶ρΌ―Ω γζ x & yώΎ‰
## εαΪεΆ°θ½ΜεΆ°ιρ½θ½¤
- κ¦Τε΅οεα®μΎΘι®ΞεΆ±EFLAGSεβΔη¤²θΦ¶εαε£λεαΈζΈ»εα«θΏΏεβΎε£μεβ¶εΆ°εα―θΊ΄κ¨2ξ®ς£

# εγΚε¦«εβ°εα«κ΅Ίεα¥εαΎη®¨νπ†
## νδ΅λύ΅θ½¶εβΈεγ£εγ³εγ—
- jmp label : εα¨εΆ¦εα§εβ£Νabelεα«εβΈεγ£εγ³εγ—
## λύ΅θ½¶εβΈεγ£εγ³εγ—
- j<εαεβΖεΆεα‹> label : <εαεβΖεΆεα‹>εαΈθ―πεβ΄ι«¶εΆ¨εα°labelεα«εβΈεγ£εγ³εγ—
- je : ZF=1ώΎ°ιµΐθΫόεαΈι­²ε΅χεα„, ξ·ΐθΫόεαΈε¤Ύεγ­ώΎ²εΆ¬εβ²ε¤Ίεγ£εγ³εγ—
- jg : ξ®¦ιο·εα¤ε£κεα§κ¦§εαΊε΅ρεβΈεΆ²εβΈεγ£εγ³εγ—
- ja : ξ®¦ιο·νδ΅εαΞεΆ©κ¦§εαΊε΅ρεβΈεΆ²εβΈεγ£εγ³εγ—
- θ½ΜεΆ­jge, jne, jleεαεα©εαεα©
## λύ΅θ½¶mov
- cmovz x, y : ZF=1εαεβ±Ξov x, y εαεα©λύ΅θ½¶εβΈεγ£εγ³εγΞεΆιπΈε΅ψεαΎε΅δεβΊε΅δεβΊε΅βεβ‹

# x64 WindowsθΊ΄εΆ°MASMντ¨ιηΊικ›
## -m masmεβεγΞε¤Ήεγ§εγ³εα®ξ·ΐθΫό(*.asmεγΚε¤£εβ¤εγ«)
```asm
_text$x segment align(64) execute # 64εγΐε¤¦εγ°ηΆ¦ιΙμεβΆεγ©εβ¤εγ³ιο―ογ½εακ°ήκ΅ΈηΎ±ογ½εαεβ»εβ°εγ΅εγ³εγ°θ·ηκ°
add_avx512 proc export # ρφΆλυ°εα®κ©¶εΆΐεβ
@L1:
vmovups zmm0, zmmword ptr [rdx] # 2νυνϋ®εα®κΎΚθΚ²εα―rdx
vaddps zmm0, zmm0, zmmword ptr [r8] # 3νυνϋ®εα®κΎΚθΚ²εα―r8
vmovups zmmword ptr [rcx], zmm0 # 1νυνϋ®εα®κΎΚθΚ²εα―rcx
add rdx, 64
add r8, 64
add rcx, 64
sub r9, 16
jnz @L1
ret
add_avx512 endp # ρφΆλυ°εα®ξ·¤ε£οεβ
_text$x ends # εβ»εβ°εγ΅εγ³εγ°εΆ°ξ·¤ε£οεβ
end # εγΚε¤£εβ¤εγ«εα®ξ·¤ε£οεβ
```
# ιρΌεα³ιηΊεαΞκ¦Ύι΄„
## Cεα¶ε£ιASMεβΔηΒΎεα³ιηΊεαη ΄ιπ
- κΎΚθΚ²εα«ιι²εβ΄η½ΖεΆ¨εβ²ε£μεβ¶ε¦®εβΈεβΉεβΏεβ¨ζΏΪη­Πε΅ωεαΉεαΊε¦®εβΈεβΉεβΏεαΈε΅βεβ‹
- ρφΆλυ°εα®κΎΚθΚ²ώΎ°θΚ¶λυ°ιώ¶ε¦½εγΪε¤¦εγ³εβΏιώ‹4ιΰ¶εΆΐεα§εα®θΐ¶ρΌ‰
  - Windows : rcx, rdx, r8, r9
  - Linux : rdi, rsi, rdx, rcx
- ιρΌεα³ιηΊεαΚε£μεαήλΜ¤λυ°ιζεΆ©θΑΪη­Πε΅ωεαΉεαΊε¦®εβΈεβΉεβΏ
  - Windows : rbx, rbp, rdi, rsi, r12-r15, rsp
  - Linux : rbx, rbp, r12-r15, rsp
- λυ΄λυ°ιώ¶εΆ°πΑΘε£κιΰ¤εα―raxεα«ιε¥εβ‹
- π«³ξ¶°
  - [Windows x64 εβ½εγΚε¥θεβ¦εβ§εβΆεα®ιρΌεα³ιηΊεαΞκ¦Ύι΄§Ύ(https://docs.microsoft.com/ja-jp/cpp/build/x64-software-conventions?view=msvc-160)
  - [x64 Linux System V Application Binary Interface](https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf)

# x64 Linux/macOSθΊ΄εΆ°GASντ¨ιηΊικ›
## -m gasεβεγΞε¤Ήεγ§εγ³εα®ξ·ΐθΫό(*.SεγΚε¤£εβ¤εγ«)
```asm
  ... νυ¥
#endif
.global PRE(add_avx512) # PRE(add_avx512)εα®εβ·εγ³εγΨε¦­εβΔη¤Μλ¦εα¶ε£ιιο¤ι©ιο―ογ½εα«εαε£λ
PRE(add_avx512): # PRE(add_avx512)εα®εβ·εγ³εγΨε¦­εβΔη®ΤιΎ©εαε£λ(PREεα―macOSεα§εβΆεγ³εγ€εγΌεβΉεβ³εβΆεβΔζ»ΠζΈΌε΅ωεβ‹)
.L1:
vmovups (%rsi), %zmm0 # 2νυνϋ®εα®κΎΚθΚ²εα―rsi
vaddps (%rdx), %zmm0, %zmm0 # 3νυνϋ®εα®κΎΚθΚ²εα―rdx
vmovups %zmm0, (%rdi) # 1νυνϋ®εα®κΎΚθΚ²εα―rdi
add $64, %rsi
add $64, %rdx
add $64, %rdi
sub $16, %rcx
jnz .L1
ret
SIZE(add_avx512) # Linuxντ¨GASεα§ρφΆλυ°εα®εβµεβ¤εβΊεβΔκ¨­κ°Τε΅ωεβ‹
```
- Linuxεα®GNU assemblerεα―κΎΚθΚ²εα®ςΆ¬ηΊΎε΅μρΰ¬εΆ­εαεβ¶ρΌ°ι΄°εα¶εΆ¬κΉ®νυ°εα―[μ©¶θΛηκΉ®νυ°](https://zenn.dev/herumi/articles/s_xbyak-assembler-2)ιο¤ι©ώΎ‰
- Windows MASMεα¨Linux GASεα®ραΚε΅δεβΔηΐΊιοΌε΅χεα¦εα¨ε£λ
# εγ¬εβ¤εγ¬ε¦µεβ·εα¨εβΉεγ«εγΌεγΞε¥γεγ
## CPUεα«εα΄ε΅ρεβ¶ε¦®εβ¤εγ¬ε¦µεβ·
- ιρ½θ½¤εαΈιΌπ£Έε΅υεβΈεΆ¨εα¶ε£ιεαΪεΆ°κ°ήκ΅Έε΅μκ°ΈζΊ¬ε΅ωεβ¶εΆΐεα§εα®λω¤λΛσώΎ°ε¤±εγ­εγ¦ε¤±εβµεβ¤εβ―εγ« : θ½¥θΊµΔlkεα¨πΠε΅ωώΎ‰
- εγ¬εβ¤εγ¬ε¦µεβ·εα4εαεβ²η®ήκ΅Έε΅υεβΈεΆ¨εα¶ε£ι4clkκΐΈεΆ­ξ·ΐθΫόεβΔη°«ντ¨ιο―ογ½
 ![width:1000px](images/20230613-175001.png)
## Intelεα«εβ°ε£λCPUεα®εβΉεγ«εγΌεγΞε¥γεγ
- ιπΈε΅ψιρ½θ½¤εβΔι¶Τε΅ρεα¦νωΊπ£Έε΅ωεβ¶εΆεαΊεΆ­κΐεΆ¦clk
  - λό¬λύ¥εα®εβΉεγ«εγΌεγΞε¥γεγ°εΆ±ινΠζ½ΊθΡβρφΖε΅βεαήε£κεα«ιη¦νπ¬εΆ©εαΊε£λρηΎεΆΆεα
- Intelεα®εβΉεγ«εγΌεγΞε¥γεγ°εΆ±ρΰ¬θΚ²(Reciprocal)εβΉεγ«εγΌεγΞε¥γεγ°εΆπ€εβΎε£μεβ¶ε΅σεα¨εαΈε΅βεβ¶ρΌ°θΛηοδ°η°¦λφ­ώΎ‰

# εβΉεγ«εγΌεγΞε¥γεγ°εΆ°θΐ‹
## FMA(Fused Multiply -Add)
- $x \rightarrow x + yz$ εβΔκ¨°ι®Ξε΅ωεβ¶ηΒΏθ½¤ώΎ―ntelεα§εα―vfmadd231psώΎ‰
- εγ¬εβ¤εγ¬ε¦µεβ·4 εβΉεγ«εγΌεγΞε¥γεγ0.5εα§ιρ½θ½¤ιπΈη£«εαΈζΎΪη­ΠλΜ¤θΑ¤ε΅μεαεα¨η ΄ιπ
 ![width:1000px](images/20230613-175628.png)
- εβΉεγ«εγΌεγΞε¥γεγ0.5εαεα®εα§1clkεαΘεΆεα«2ιρ½θ½¤νωΊπ£ΈεΆ©εαΊε£λ
- θΐΪη­ΠλΜ¤θΑ¤ε΅μνδ΅εα¨εΆ¬εβ²θ¬΅εα®ιρ½θ½¤εα―1clkκΐΈεΆ­νωΊπ£ΈεΆ©εαΊε£λ
  - ξ·ΐθΫόεβΔη°«ντ¨εα§εαΊε£λεα®εα―4clkκΐΈεΆ­εαεβ‹
- cf. [ξ®¬1ιϋ π°ι®Ξι§Βη­¦λκ€π£Ζι²»π­ΛΆώΎ2023ώΎ±Ύ(https://www.docswell.com/s/2300203199/KJLL2G-2023-04-12-102338#p41)

# FMAεα®εβΉεγ«εγΌεγΞε¥γεγ°ε£ςξ¤Ίπ¬Ίε΅ωεβ¶η®ήλ¨“
## κ°ήλ¨Ζε¤µεγΌεγ‰
- εγ«εγΌεγΞη«εεα«θΌΔε΅δεα«θΐΪη­ΠλΜ¤θΑ¤εΆ°νδ΅εα§§MAεβΔκ¤®θΚ²ιΰ¶ζΈ¦εαΉεα¦ρΰήηΊ¦π«ΚζΎ΅εαε£λ
```python
def gen_func(n):
  with FuncProc(f'func{n}'):
    with StackFrame(1, vNum=n+1, vType=T_ZMM) as sf:
      c = sf.p[0]
      lp = Label()
      for i in range(n):
        vxorps(Zmm(i), Zmm(i), Zmm(i)) # ZMMεγ¬εβΈεβΉεβΏεβ―εγεβΆ
      align(32)
      L(lp)
      for i in range(n):
        vfmadd231ps(Zmm(i), Zmm(i), Zmm(i)) # nιΰ¶εΆ°FMAεβΔιΌπ£
      sub(c, 1)
      jnz(lp) # cιϋάε¦­εγΌεγΞε΅ωεβ‹
```
- εβ³εγΌεγ²ηθΏΖεΆ±[fma](https://github.com/herumi/misc/tree/main/fma)
- Xeon Platinum 8280 Turbo Boost offεα§μΊ¬κ°

# ντήθ―πεβ³εγΌεγ‰
## n=1
```asm
@L1:
vfmadd231ps zmm0, zmm0, zmm0
sub rcx, 1
jnz @L1
```

## n=4 εα®εγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«
```asm
@L4:
vfmadd231ps zmm0, zmm0, zmm0
vfmadd231ps zmm1, zmm1, zmm1
vfmadd231ps zmm2, zmm2, zmm2
vfmadd231ps zmm3, zmm3, zmm3
sub rcx, 1
jnz @L4
```

# κ°ήλ¨ΖιµΐθΫό
## nεβΔηΆΞε£δεαΞεΆ΅εα¨εαΊεΆ°1εγ«εγΌεγΞε΅βεαήε£κεα®ιη¦νπ¬θΡβρφ“

n|1|2|3|4|5|6|7|8|9|10
-|-|-|-|-|-|-|-|-|-|-
clk|4.1|4.0|4.0|4.0|4.0|4.0|4.0|4.0|4.5|5.0|5.50
- n=8εαΎεα§εα®εγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«εα―λω¤λΛσεαΈη¤²η·φεαΞεΆ¬εα¨ρΌ°ε¤»εγ«εγΌεγΞε¥γεγ0.5εα§ιη¦νπ¬εΆ©εαΊεΆ¨εα¨ε£λώΎ‰
- FMAεα®ρΰ£ξΈΤιΌπ£ΈεΆ°μ·Άε£μ
 ![width:1000px](images/20230614-095612.png)

# FMAεα®ιθ©ντ¨θΐ‹
## κ¦Τλ ηΌΎεΆ°π«ΚζΎ΅
  - $n$ μ®΅κ¦Τλ ηΌ $f(x) = a_0 + a_1x + a_2x^2 + \cdots + a_nx^n$ εα® $x=x_0$ εα«εα΄ε΅ρεβ¶η€¤εβΔκ¨°ι®Ξε΅ωεβ‹
## $n=4$ εα®εα¨εαΊεΆ°μ³¤ε£αλφΉ
  - $f(x)= a_0 + x(a_1 + x(a_2 + x(a_3 + x a_4)))$ εα¨κ¦²η½Άεαε£λ
$t \leftarrow a_4$ εα¨εαΞεΆ¨κΐΈε£νεα¶ε£ιμ³¤ε£αεβ‹
1. $t \leftarrow a_3 + x t$
2. $t \leftarrow a_2 + x t$
3. $t \leftarrow a_1 + x t$
4. $t \leftarrow a_0 + x t$
- εαΪε£μεαάε£μεα®π°ι®ΞεΆ­FMAεβΔη°«ντ¨εαε£λ
- ιπΈε΅ψκ¦Τλ ηΌΎεΆ­κ±Ύεαε£λπ¦®θΚ²εα® $x_i$ εα«εβ°ε£λπ«ΚζΎ΅εα―εγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«εαΞεΆ¨εγ¬εβ¤εγ¬ε¦µεβ·εβΔλΤΆεα™

# θΑ¤θΚ²εα®θΑΪθ·αλφΉμµ•
## θΑ¤θΚ²εβΔηεα¦εγ¬εβΈεβΉεβΏεα«θΑΪθ·αεαε£λ
- εγ¬εβΈεβΉεβΏεαΈκ¶³εβ΄εΆ¬εαΎεΆ¬εβ¶ηΎ±ογ½λΰ§εαΈε΅βεβ‹
- θΏκ£Κε΅μεα¤ε£λεαεβ²ε¦®εβΈεβΉεβΏεα«ξΏ®εα¨εΆ¨εα΄ε΅οεα®εαΈε£θεα„
## θΑ¤θΚ²εβΔε¦£εγΆεγεα«θΑΪθ·αεαε£λ
- εγ΅εγΆεγεα«SIMDιθ¬ζΈ¦εαΉεα¦εα΄ε΅δεα¦π¬­εβ€
- εγ΅εγΆεγεα«1ιΰ¶η―ζεα εαΒε΅κεα¨εΆ¨SIMDεγ¬εβΈεβΉεβΏεα«ιΰ¶θΚ²ιθ¬εΆΆεαΒη±ΚλΛλεαε£λώΎ°ε¥φεγ­εγΌεγ²ε¤―εγ£εβΉεγ°ρΌ‰
![width:800px](images/20230614-113346.png)

# εγΜε¦―εγΌεγ²ε¤―εγ£εβΉεγ°εΆ°λφΉμµ•
## εγΜε¦―εγΌεγ²ε¤―εγ£εβΉεγ°ι¨£εαΞεΆ°FMA
```python
# coeff
#   |c0|c0|c0|...|c0|c1|c1|...
vfmadd231ps(zmm0, zmm1, ptr(coeff)) # coeffεα¶ε£ι16ιΰ¶η―ζεα®ιπΈε΅ψfloatεβΔκ­εαΏπΐΌεαΏFMA
```
## εγΜε¦―εγΌεγ²ε¤―εγ£εβΉεγ°ηΒΏθ½¤vbroadcastss
```python
# coeff
#   |c0|c1|c2|...
vbroadcastss(zmm2, ptr(coeff)) # coeffεα¶ε£ι1ιΰ¶η―ζεα®floatεβΔκ­εαΏπΐΌεαΏzmm2εα«κ³ΚλΛλεαε£λ
vfmadd231ps(zmm0, zmm1, zmm2)
```
## FMA+ptr_bώΎ°ε¥φεγ­εγΌεγ²ε¤―εγ£εβΉεγ°ε¥υεγ©εβ°ώΎ‰
```python
vfmadd231ps(zmm0, zmm1, ptr_b(coeff)) # coeffεα¶ε£ι1ιΰ¶η―ζεα®floatεβΔκ­εαΏπΐΌεαΏκ³ΚλΛλεαΞεΆ¨FMA
```

# κ°ήλ¨ΖιµΐθΫό
## εγ«εγΌεγΞη±ΚλΛλεαΞεΆ΅εα¨εαΊεΆ°εαΪε£μεαάε£μεα®ιη¦νπ¬θΡβρφ“

N|1|2|3|4|5|6|7|8|9
-|-|-|-|-|-|-|-|-|-
ιε¨ργ¨εγ¬εβΈεβΉεβΏ|4.13|4.02|4.00|4.00|4.00|4.00|4.00|4.00|4.57
broadcast|4.13|4.01|4.00|4.00|4.00|4.06|4.22|4.74|5.25
ptr_b|4.14|4.01|4.00|4.00|4.00|4.00|4.06|4.38|4.97

- ιε¨ργ¨εγ¬εβΈεβΉεβΏεαεβ±―=8εαΈε£θεα„
- εγ΅εγΆεγεα¶ε£ιπ¬­εαΏεαεαΈε£ιεαεβ±Ρtr_bεβΔζ½Ώεα¬εΆ°εαΈε£θεα„

# exp(x)εα®πΑΒζΌΌπ°ι®—
## εβΆεγ«εβ΄εγεβΊεγ 
- $\exp(x) = e^x$ εβ’2εγε¤―εα®κΏΆεα«εαε£λ
  - $e^x=2^{x\log_2 e} = 2^y.$ ώΎ$y=x \log_2(e)$ώΎ‰
- $y$ εβΔθΚ¶λυ° $n$ εα¨κ²ΎθΚ²ργ¨ιθ† $a$($|a|\le 1/2$)εα«ιθ¬η²΄εαε£λ
  - $y = n + a$ εα¨εαε£λεα¨ $e^x=2^y = 2^n \times 2^a.$
## $2^n$ εα®π°ι®—
- $n$ εαΈθΚ¶λυ°εαεα®εα§εγΖε¥γεγ°θΌΘι®ΞεΆ©ιη¦νπ¬εΆ©εαΊε£λ
## $2^a$($|a|\le 1/2$)εα®π°ι®—
- floatεα®ξ΄ΎκΌ¦ `1b-23`=$2^{-23}$ εα«πΑΒε΅οεαεβ¶εΆΐεα§εγ­εγΌεγ©εγ³κ³ΚλΛλεαε£λ
  - $e^x=1+x+x^2/2!+x^3/3!+\cdots$

# Sollya
## πΑΒζΌΌπ°ι®ΞεΆ°εαήε£αεα®εβ½εγΚε¥θεβ¦εβ§εβΆ https://www.sollya.org/
- λυ°κ―¦εα®ιε¬κΎΎεΆ°εγ­εγΌεγ©εγ³κ³ΚλΛλεβ°ε£κεβ¤ε£θεβ΄ε£θεα¨η€¤εβΔθ½πξ¦ΊεαΞεΆ¨εαΎε£μεβ‹
## μ®΅λυ°εα®π¨¶ι©Ίε£βεβ
```sh
>guessdegree(2^x,[-0.5,0.5],1b-23);
[5;5]
```
## κ¦Τλ ηΌΎκΏΒζΌΌ
```sh
>fpminimax(2^x,[|1,2,3,4,5|],[|D...|],[-0.5,0.5],1);
1 + x * (0.69314697759916432673321651236619800329208374023437
   + x * (0.24022242085378028852993281816452508792281150817871
   + x * (5.5507337432541360711102385039339424110949039459229e-2
   + x * (9.6715126395259202324306002651610469911247491836548e-3
   + x * 1.326472719636653634089906717008489067666232585907e-3))))
```
# εβΆεγ«εβ΄εγεβΊεγ εα®εαΎεα¨εβ
## exp(x)εα®πΑΒζΌΌπ°ι®—
- ιε¥ικ› : x
- ιηΊικ› : exp(x)
- θΌ¶η±νμΌΜη£ω : c[i] : κ¦Τλ ηΌΎεΆ°θΑ¤θΚ²
1. $y \leftarrow x \times \log_2(e).$
1. $n \leftarrow {\tt round}(x).$  εαΖε΅σεα§ ${\tt round}$ εα―ιϋΦθΊθΌΘη§ρφΆλυ°εΰ‚
1. $a \leftarrow x - n.$
1. $w=2^a \leftarrow 1 + a(c[1] + a(c[2] + a(c[3] + a(c[4] + a c[5])))).$
1. $z \leftarrow 2^n.$
1. return $zw$.

# $2^n w$ εα®π°ι®—
## ρΰΤηΈΈεα®λφΉμµ•
- floatεα®εγΖε¥γεγ°κ΅¨νοΎ

floatεα®εγΖε¥γεγ°κ΅¨νοΎ|ξ®¦ιο·s|λμ®θΚ²ργ¨e|θ½®λυ°ργ¨f
-|-|-|-
εγΖε¥γεγ°λΚΉ|1|8|23
- $x=(-1)^s \times 2^{e-127} \times (1+f/2^{23}).$
- `(n+127)<<23`εα $2^n$ εα«κ±ΎκΑΨε΅ωεβ‹
## AVX-512εα®κΆ΄ιπ
- n : floatιώ¶εΆ°λυ΄λυ°
- w : floatιΰ¤
- vscalefps(n, w) εα§ $n \leftarrow 2^n \times w$ εα¨εαεβ‹

# ιϋΦθΊθΌΘη§
## cvtps2dq
- floatγζΓΚntκ¦²θ½ϋ : AVX-512εα§θΊΈεβΆε¦¤εγΌεγ²ε£ςιθ¶κ°ΤεΆ©εαΊε£λ
- θΊΈεβΆε¦¤εγΌεγ‰(ctrl)
  - round-to-nearest-even : θΊΈεβΆε¦¤εγΌεγ²εΆ°εγ®ε¥υεβ©εγ«εγ
  - round-toward-zero : 0εα«πΑΒε΅δλφΉιπΒεΆ­θΊΈεβΆε£λ
  - round-down : 0εα«ρα εα¨θΜ»ιπΒεΆ­θΊΈεβΆε£λ
  - round-up : 0εα«ρα εα¨θΜ»ιπΒεΆ­θΊΈεβΆε£λ
- ξ·ΐθΫόεα―intιώ¶εΆ¬εα®εα§floatιώ¶εΆΊεα®κ¦²θ½ϋεαΈηΏκ¦
## vrndscaleps
- ${\tt ROUND}(x) = 2^{-M} {\tt round}(x \times 2^M, {\tt ctrl}).$
- ξ·ΐθΫόεα―floatιώ‹

# vreduceps
## ιε°εΆ­κ²ΎθΚ²ργ¨εβΔθ±¤ε£αεβ¶ηΒΏθ½¤
- ${\tt vreduceps}(x)=x - {\tt ROUND}(x).$

## εγ¬εβ¤εγ¬ε¦µεβ·εα¨εβΉεγ«εγΌεγΞε¥γεγ
ιρ½θ½¤|εγ¬εβ¤εγ¬ε¦µεβ·|εβΉεγ«εγΌεγΞε¥γεγ
-|-|-
vrndscaleps|8|1
vreduceps|4|0.5-1

ιε°εΆ­λυ΄λυ°ργ¨ιθ«έιε°εΆ­κ²ΎθΚ²ργ¨ιθ†
-|-
n γζ vrndscaleps(x)  | a γζ vreduceps(x)
a γζ x - n           | n γζ x - a
- ιε°εΆ­κ²ΎθΚ²ργ¨ιθ¬ε£ςμ³¤ε£αεβ¶θΜ»εαΈλ€ήε΅οεα¦ργ½ιπ°ε΅μεβ°ε΅δώΎ―Οεβ°ε£κaεαΈη©θεα«κΑκ¦ΆρΌ‰

# κ°ήκ£ζΎ‹
## εβ³εβΆργ¨ιθ†
- ιε¥ικ› : v0
- ιηΊικ› : v0 = exp(v0)
- θΌ¶η±νμΌΜη£ω : log2_e, expCoeff[5]εα®εγ¬εβΈεβΉεβΏεα«ιΰ¤εβΔκ¨­κ°Τε΅χεα¦εα΄ε΅ο
```python
# v0 = exp(v0)
vmulps(v0, v0, self.log2_e)
vreduceps(v1, v0, 0) # a = x - n
vsubps(v0, v0, v1) # n = x - a = round(x)

vmovaps(v2, self.expCoeff[5])
for i in range(4, -1, -1):
  vfmadd213ps(v2, v1, self.expCoeff[i])
vscalefps(v0, v2, v0) # v2 * 2^n
```

# s_xbyakεα«εβ°ε£λεγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«
## Pythonεα«εβ°ε£λεγάε¤±εγ­νϊ¨εΆ¬θΏΏεα¨θΜ»
- θΐ‹
```python
vfmadd231ps zmm0, zmm0, zmm5
vfmadd231ps zmm1, zmm1, zmm5
vfmadd231ps zmm2, zmm2, zmm5
vfmadd231ps zmm3, zmm3, zmm5
```
εα―
```python
v = [zmm0, zmm1, zmm2, zmm3]
unroll(vfmadd231ps)(v, v, zmm5)
```
εα¨ώΎ°εΆ΅εα¨εα°εΆ²ώΎ²θΦΊεαΒε£λεα¨θΐΏιθ©

# εγ΅εγΆεγιο¤ι©εα®εγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«
## εγάε¤±εγ­εα®ξΈΤε΅ν
```python
vfaddps(zmm0, zmm0, ptr(rax))
vfaddps(zmm1, zmm1, ptr(rax+64))
vfaddps(zmm2, zmm2, ptr(rax+128))
```
εαεβ‰
```python
v = [zmm0, zmm1, zmm2]
unroll(vfaddps)(v, v, ptr(rax))
```
- οηιλΚιΣδεα«εβεγΚε¤½εγ¦ε¥θεβΔζ»ΠζΈΌε΅χεα¦εα»εαΞε΅δ
- ptr_bεβΔζ½Ώεα£εα¦εα¨εΆ΅εβ²ε¤¬εγΚε¤½εγ¦ε¥θεα―εα¤εαΒεΆ¬εα¨εΆ©εα»εαΞε΅δ?

# εβΆεγ³εγ­εγΌεγ«μ«ήκ¦Ώεα®θΐ‹
## Pythonεα®οηντ±κΌ¦εα®ς­Πε΅υεβΔη°«ντ¨εαε£λ
```python
def Unroll(n, op, *args, addrOffset=None):
  xs = list(args)
  for i in range(n):
    ys = []
    for e in xs:
      if isinstance(e, list): # κΎΚθΚ²εαΈλ©νιθΞεΆ¬εβ±Κνυνϋ®εβΔη°«ντ¨εαε£λ
        ys.append(e[i])
      elif isinstance(e, Address): # κΎΚθΚ²εαΈε¤¤εγ²ε¦®εβΉεαεβ‰
        if addrOffset == None:
          if e.broadcast:
            addrOffset = 0 # broadcastεγΆεγΌεγ²εΆ¬εβ²ε¤¬εγΚε¤½εγ¦ε¥θ0ώΎ°ε΅σεα®εα¤εΆ΅εβ΄εΆ±κ§½εαΏεα§ώΎ‰
          else:
            addrOffset = SIMD_BYTE # εαΪε΅ζεα§εαεα¨εΆεαΊεΆ±SIMDεα®εβµεβ¤εβΊεαΤε£ιεα™(addrOffsetεα§ξ¶°εα¶ε΅διθ¶κΐ΅εα―εα§εαΊε£λ)
        ys.append(e + addrOffset*i)
      else:
        ys.append(e)
    op(*ys)
```

# unrollεα®ιθ©ντ¨θΐ‹
## εγΠε¦­εγΒε¦ΎρφΆλυ°
- εβΆεγ³εγ­εγΌεγ«ιϋάθΚ²NεβΔηΌΚθΚ²εα¨εαΞεΆ¨εΰΆε¤¬εγΤε¦«εγ³εγ±ΠpεβΔη½φεβ΄ηΌΚθΚ²εα«κ±ΎεαΞεΆ¨εβΆεγ³εγ­εγΌεγ«εαε£λρφΆλυ°εβΔκΏΘε΅ω
```python
def genUnrollFunc(n):
  """
    return a function takes op and outputs a function that takes *args and outputs n unrolled op
  """
  def fn(op, addrOffset=None):
    def gn(*args):
      Unroll(n, op, *args, addrOffset=addrOffset)
    return gn
  return fn
  ```

```python
# v0 = [zmm0, zmm1, ...], v1 = [zmm4, zmm5, ...], ...
un = genUnrollFunc(n) # εβΆεγ³εγ­εγΌεγ«ιϋάθΚ²εβΔθ·ηκ°Τε΅ωεβ‹
un(vmulps)(v0, v0, self.log2_e)
un(vreduceps)(v1, v0, 0) # a = x - n
un(vsubps)(v0, v0, v1) # n = x - a = round(x)
```

# εβΆεγ³εγ­εγΌεγ«εαΚε£μεαήε¤µεγΌεγ‰
## π¦®θΚ²εα®εγ¬εβΈεβΉεβΏ
```python
v0=[zmm0, zmm1, zmm2]
un(vmulps)(z0, z0, log2_e)  γζ’ vmulps(zmm0, zmm0, log2_e)
                              vmulps(zmm1, zmm1, log2_e)
                              vmulps(zmm2, zmm2, log2_e)
```
## εγ΅εγΆεγιο¤ι©
```python
v0=[zmm0, zmm1, zmm2]
v1=[zmm2, zmm3, zmm4]
un(vfmadd231ps)(v0, v1, ptr(rax)) γζ’ vfmadd231ps(zmm0, zmm2, ptr(rax))
                                    vfmadd231ps(zmm1, zmm3, ptr(rax+64))
                                    vfmadd231ps(zmm2, zmm4, ptr(rax+128))
```
# exp(x)εα®εγε¦µεγΆε¥ώεγΌεβ―
## εβΆεγ³εγ­εγΌεγ«ιϋάθΚ²NεβΔη¤²ε΅θεα¦μΊ¬κ°

N|1|2|3|4|5|6|7|8
-|-|-|-|-|-|-|-|-
ιε¨εα¦εγ¬εβΈεβΉεβΏ|17.91|15.89|14.14|13.85|13.68|13.08|13.03|13.78
κ°ΤθΚ²εβΓΡtr_bεα§π¬­εβ€|18.06|16.21|14.82|14.37|14.54|14.61|14.66|16.19

- ιε¨εα¦εγ¬εβΈεβΉεβΏεα«ξΏ®εαΎη ΄ιπ°εΆ±N=7εαΈε£θεα¶εΆ¥εα
  - εα¤εΆΐεβ΄ε¤¤εγ³εγ­εγΌεγ«εαε£λεα¨ιρ½θ½¤εβ­εγ£εγ¦ε¤Ήεγ¥εβΔηΨ©πΑ«εαΞεΆ¨εαΞεΆΐεα†
- θΊ€ργ¨εα®κ°ΤθΚ²εβΔε¦£εγΆεγεα«ξΏ®εα¨εΆ΅κΆ΄ιπ°εΆ±N=4εαΈε£θεα¶εΆ¥εα
- ιε¨θΏΖεΆ°εβ³εγΌεγ²εΆ±[fmath](https://github.com/herumi/fmath)εα®[gen_fmath.py](https://github.com/herumi/fmath/blob/master/gen_fmath.py)

# log(x)εα®πΑΒζΌΌπ°ι®—
## εβΆεγ«εβ΄εγεβΊεγ εα®λφΉρη
- $x$ εβ’ $2^n a$($n$ εα―λυ΄λυ° $1 \le a < 2$)εα®κΏΆεα«ιθ¬κ§£εαε£λ
- $\log(x) = n \times \log(2) + \log(a).$
- $1 \le a < 2$ εα«κ±Ύεαε£λ $\log(a)$ εβΔθ±¤ε£αεβ¶ε΅σεα¨εα«κ²¤ηΏµεαε£λ
## εγ­εγΌεγ©εγ³κ³ΚλΛλ
- $\log(1+x) = x - x^2/2 + x^3/3 - x^4/4 + \cdots.$
- $x \sim 1$ εα§εα―ιοΌθΪ΅εαΈλ΅εεα„

# ιοΌθΪ΅εβΔλ€ήε΅οεαε£λεαήε£αεα«ξ±¨ηΦ΄εβΔι¶―εβΆε£λ
## κ¦©θΊ¶ε£κεα εα
- $b$ εβ’ $1/a$ εα®πΑΒζΌΌιΰ¤εα¨εαε£λ
- $c = ab-1$ εα¨ξΏ®εαΎεΆ$b\sim 1/a$ εαεα®εα§ $c$ εα―0εα«πΑΒε΅δ
- $a=(1+c)/b$ εα¨κ¦²η½ΆεαΞε€Άη―Ύλυ°εβΔη½φεβ¶εΆ
- $\log(a) = \log(1+c) - \log(b).$
## εβ¤ε΅χ $\log(b)$ εβΔκ¨°ι®ΞεΆ©εαΊε£λεαεβ‰
- $a$ εβ°ε£κεβ¤ε£θεβ0εα«πΑΒε΅δ $c$ εα«εα¤εα¨εΆ¨ $\log(1+c)$ εβΔθ±¤ε£αεβΈεΆ²εβ°ε΅δ
## $\log(b)$ εα®π°ι®—
- $a$ εα―[1, 2)εα®ξ±¨ηΦ΄εαεα®εα§θΊ΄ζ½9εγΖε¥γεγ(ξ®¦ιο·+λμ®θΚ²ργ¨)εα―ιϋΊκ°Τε΅υεβΈε£λ
- θ½®λυ°ργ¨εα®θΊ΄ζ½Ίε¥σεγ¦ε¥θεα§εγ¬ε¦ΎεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χεβΔε΅ωεβΈεΆ² $b$ εαΈθ±¤εΆΐεβ‹

# εγ¬ε¦ΎεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χ
## $a$ εα®θ½®λυ°ργ¨εα®θΊ΄ζ½Ή­εγΖε¥γεγ°ε£ςιθ©ντ¨εαε£λ
![width:700px](images/log-table.png)
- $a$ εα®θΊ¶ζ½ $23-L$ εγΖε¥γεγ°ε£ςεγάε¤»εβ―εαΞεΆ¨πΑΒζΌΌιΰ¤ $a'$ εβΔηΎΞε£λ
- $d=m>>(23-L)$ εβΔε¤¦εγ³εγ®ε¥γεβ―εβΉεα¨εαε£λ
- tbl1εα«εα― $1/a'$, tbl2εα«εα― $\log(1/a')$ εα®ιΰ¤εβΔη§εβΈεΆ¨εα΄ε΅ο

# εγ¬ε¦ΎεγΜε¦­εα®θΏΨθ―π
## Pythonεβ³εγΌεγ‰
```python
self.logTbl1 = []
self.logTbl2 = []
self.L = 4
LN = 1 << self.L
for i in range(LN):
  u = (127 << 23) | ((i*2+1) << (23 - self.L - 1))
  v = 1 / uint2float(u)
  v = uint2float(float2uint(v)) # (X) 32εγΖε¥γεγ°εΆ°floatιΰ¤εα«κΎ·ιθ¶κ¦²θ½ϋ
  self.logTbl1.append(v)
  self.logTbl2.append(math.log(v))
```
- uint2floatεα―uint32_tεα®ιΰ¤εα«κ±ΎκΑΨε΅ωεβµΗloatιΰ¤εβΔηΎΞε£λρφΆλυ°
- float2uintεα―floatιΰ¤εα«κ±ΎκΑΨε΅ωεβµΦint32_tεα®ιΰ¤εβΔηΎΞε£λρφΆλυ°
## (X)εα®λδΎηΒµ
- Pythonεα®floatεα―Cεα«εα΄ε΅ρεβµΕoubleεαεα®εα§εΰΆε΅ύεα®εαΎεαΎθΏΏεα¬εΆεβ¤εγ³εγ®ε¥γεβ―εβΉεαΈρΌ°η°Βε΅χώΎ²ε΅ϊεβΈε£λ

# AVX-512εα«εα΄ε΅ρεβ¶ε¥ζεγΌεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χ
## vgatherιρ½θ½¤
```python
vgatherdd(out|k, ptr(rax + idx*4)) # out[i] = *(rax + idx[i])
```
- π¦®θΚ²εα®εβ¤εγ³εγ®ε¥γεβ―εβΉεβΓ΄IMDεγ¬εβΈεβΉεβΏεα«ιε¥εβΈεΆ¨1ιρ½θ½¤εα§π¦®θΚ²εα®εγ¬ε¦ΎεγΜε¦­ιο¤ι©εβΔκ΅Έε΅ζ
- θΐΏιθ©εα εαΈλ΅εεα¨ρΌ°ε¦®εβ¤εγ¬ε¦µεβ·20θ½¥θΊ+εγ΅εγΆεγεβΆεβ―εβ»εβΉώΎ‰
## vpermps
```python
vpermps(x, y, z) # x[i] = y[z[i]]
```
- floatεα16(=1<<L)ιΰ¶η§εβµ»MMεγ¬εβΈεβΉεβΏεβΔε¥ζεγΌεγΜε¦­εα¨εαΞεΆ¨ιθ©ντ¨ώΎ°ε¦®εβ¤εγ¬ε¦µεβ·3ώΎ‰
## vpermi2ps
- 512εγΖε¥γεγ―»MMεγ¬εβΈεβΉεβΏ2ιΰ¶ε£ςεγ¬ε¦ΎεγΜε¦­εα¨εαΞεΆ¨ιθ©ντ¨ώΎ°ε¦®εβ¤εγ¬ε¦µεβ·3ώΎ‰
- θ½΄ηΥώεα―ώΎ°λ΅εεαΎεΆ¬εα£εαήεΆ°εα§ώΎ²ζ½ΏεβΎεΆ¬εα„

# θ½®λυ°ργ¨εα¨λμ®θΚ²ργ¨εα®ιη¦νπ†
## κΐΖθΪ§εα®λφΉμµ•
- floatεα®εγΖε¥γεγ°κ΅¨νοΎεβΔιΘεα¨εΆ¨θ½®λυ°ργ¨εα¨λμ®θΚ²ργ¨εβΔη½φεβ΄η®Όεα™
- e = (x >> 23) - 127, m = x & mask(23)
## AVX-512εα®λφΉμµ•
- vgetexpss # floatεα®λμ®θΚ²ργ¨εβΔη½φεβ΄η®Όεα™
- vgetmantss # floatεα®θ½®λυ°ργ¨εβΔη½φεβ΄η®Όεα™
- εγΖε¥γεγ°θΌΘι®Ξε£δθΏκ¨°εΆ¬κ°ΤθΚ²εβΔζΏΪθ·αεαε£λκΑκ¦Άε΅μεαεαΎλ«Πλ€

# log(x)εα®κ°ήκ£ζΎ‹
## εγ­εγΌεγ©εγ³κ³ΚλΛλεβΔε΅ωεβ¶η±νιη¦νπ†
- ιε¥ικ› : v0
- ιηΊικ› : v1
- θΊ€λω¤η¤²θΚ² : v2, v3
- κ°ΤθΚ² : L = 4, tbl1, tbl2, one=1.0
```python
un(vgetexpps)(v1, v0) # n
un(vgetmantps)(v0, v0, 0) # a
un(vpsrad)(v2, v0, 23 - self.L) # d = v0 >> (23-L)
un(vpermps)(v3, v2, self.tbl1) # b = tbl1[d] = 1/a
un(vfmsub213ps)(v0, v3, self.one) # c = a * b - 1
un(vpermps)(v3, v2, self.tbl2) # log_b = tbl2[d] = log(1/a)
un(vfmsub132ps)(v1, v3, ptr_b(rip+self.LOG2)) # z = n * log2 - log_b
```
- εαΖε΅σεα¶ε£ιv0εα«κ±ΎεαΞεΆ¨ log(v0) εβΔε¦―εγΌεγ©εγ³κ³ΚλΛλεα§μ³¤ε£αεβ‹

# log(1+x)εα®εγ­εγΌεγ©εγ³κ³ΚλΛλ
## 4μ®΅εα§λιΖεΆ£ιθ®εΆ¥εαήθΚ²κΎΎεΆ°κΆ΄ιπ
- $\log(1+x)=x-x^2/2+x^3/3-x^4/4.$
## 4μ®΅εα§λιΖεΆ£ιθ®εΆ¥εα¦θΑ¤θΚ²εβΔκΏλυ΄εαΞεΆ΅κΆ΄ιπ
- $\log(1+x)=x-0.49999999 x^2 + 0.33339557 x^3 -0.25008487 x^4.$
```c
// νϋΈκ±Ύπ¬¤κΉ®
float relErr(float x, float y) { return x == 0 ? 0 : std::fabs(x - y) / std::fabs(x); }
```
- ιμΊρφΕΌ1-1/32,1+1/32]εα§xεβ’1e-6εαΤεΆ¦κ¦²θΦ¶εαΞεΆ΅εα¨εαΊεΆ°std::logεα¨εα®π¬¤κΉ®

κΎ½έλυ°κΎ½έπ¥Ψθ­£
-|-|-
λό€κ¦§π¬¤κΉ®| 3.54e-7| 2.44e-7
κ»³ιύ®κ¤κΉ®|4.91e-8|3.97e-8

# x~1εα®εα¨εαΊεΆ°π°ι®ΞθΜ»μµ•
## ξ΄ΎκΌ¦ικ£ιμ–
- $\log(1)=0$ εαεα®εα§ $x\sim 1$ εα®εα¨εαΊεΆ±νϋ΄λξ¥εγ­εγΌεγ©εγ³κ³ΚλΛλεβΔη°«ντ¨εαΞεΆ΅λφΉεαΈε£θεα„
- εγ¬ε¦ΎεγΜε¦­ιο¤ι©εα®ιη¦νπ¬ε΅μιε¥εβ¶εΆξ΄ΎκΌ¦εαΈκΐΏεα΅εβ‹
- ιμΊρφΖη«εεα§xεβ’1e-6εαΤεΆ¦κ¤Ξε£δεαΞεΆ¬εαΈε£ιstd::log(x)εα¨εα®νϋΈκ±Ύπ¬¤κΉ®εβΔθ±¤ε£αεβ‹

ιμΊρφΕέ[0.99,1.01]|[2,3]
-|-|-
λό€κ¦§π¬¤κΉ®|2.80e-2|1.19e-7
κ»³ιύ®κ¤κΉ®|2.61e-5|2.38e-8
- ιμΊρφΕΌ0.99,1.01]εα―ιμΊρφΕΌ2,3]εα«μ±ΘεΆ»εα¦ξ΄ΎκΌ¦ικ£ιμΜε΅μκ¦§εαΊε΅δ

# ιθ¬η²ΐε΅μκΑκ¦
## μ¨¤ηΏµνϊ¨εΆ¬εβ³εγΌεγ‰
```python
if math.abs(x-1) < B: # Bεα―ρα©κΏΖεΆ¬κ¤¦ιΙμιΰ¤
  return log(1+x)εα®εγ­εγΌεγ©εγ³κ³ΚλΛλ
else:
  return εγ¬ε¦ΎεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χεα®κΐΈε¦―εγΌεγ©εγ³κ³ΚλΛλ
```
## SIMDεα§εα®ιθ¬η²
- π¨Άι΄ εαΘεΆεα«ιθ¬η²ΐε΅ωεβ¶εΆ°εα―ιϋ°ρϋ£
- θΊ΅λφΉεα®π°ι®Ξε£ςεαΞεΆ¨εα΄ε΅νεΰΆιµΐθΫόεβΔε¥ώεβΉεβ―εα§ραΈλκάε΅ωεβ‹
```python
v1 = compute_if_true(x)
v2 = compute_if_false(x)
cond = math.abs(x-1) < B # x~1εα®ιθ¤κ°
mask = 0xffffffff if cond else 0
return (v1 & mask) | (v2 & ~mask)
```

# AVX-512εα«εα΄ε΅ρεβ¶η―ζκ΄
## 64εγΖε¥γεγ°εΆ°εγάε¤»εβ―εγ¬εβΈεβΉεβΏk1, ..., k7
- iεγΖε¥γεγ°ιΦ°εα
  - 1εαεβ±»MMεγ¬εβΈεβΉεβΏεα®iνυνϋ®εα®λσΊζ½Ψε£ςλό²η΄»εα«εαε£λ
  - 0εαεβ²η€¤εβΔη¤²θΦ¶εαΞεΆ¬εα„
## faddps(x|k, y, z)

y|$y_0$|$y_1$|$y_2$|...|$y_{15}$
-|-|-|-|-|-
z|$z_0$|$z_1$|$z_2$|...|$z_{15}$
k|$k_0=1$|$k_1=0$|$k_2=0$|...|$k_{15}=1$
x|$y_0+z_0$|$x_1$|$x_2$|...|$y_{15}+z_{15}$

# ιθ¬η²ΐε¤µεγΌεγ²εΆ°λμΏιε¥θΏΊι½®
## π°ι®ΞεΆ°μ·Άε£μ
1. ιε¥ικ› : v0 = x
1. εγ¬ε¦ΎεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χιη¦νπ¬ηΎ
1. v0 γζ c = ab - 1
1. v1 γζ n * log2 - log_b
1. ώΎ°θΈΑιε¥ώΎ²ε΅σεαΖεΆ© $|x-1|<B$ εαεβ‰ v0 γζ x-1, v1 γζ 0 εα¨εαε£λ
1. v2 γζ log(1+v0) # εγ­εγΌεγ©εγ³κ³ΚλΛλ
1. v0 γζ v2 + v1 # ιηΊικ› log(x)

# λμΏιε¥εαε£λεβ³εγΌεγ‰
## |x-1|< B εβΔιΆΊπ¬Ίε΅ωεβ‹
- keepX γζ v0
```python
un(vsubps)(v2, keepX, self.one) # x-1
un(vandps)(v3, v2, ptr_b(rip+self.C_0x7fffffff)) # |x-1|
un(vcmpltps)(vk, v3, ptr_b(rip+self.BOUNDARY))
un(vmovaps)(zipOr(v0, vk), v2) # c = v0 = x-1
un(vxorps)(zipOr(v1, vk), v1, v1) # z = 0
```
- floatεα®ξ·¶κ±Ύιΰ¤εα―λό€θΊ΄ζ½Ίε¥σεγ¦ε¥θεβΔκΐΏεα¨εαρΌ0x7fffffffεα¨andώΎ‰
- vcmpltpsεα§μ±ΘκΌ¦ε΅χεα¦εγάε¤»εβ―εγ¬εβΈεβΉεβΏvkεα«ξ·ΐθΫόεβΔθ Όξ¶
- zipOrεα―v0εα¨vkεα®π¨Άι΄ εβΓΠrεαε£λεγΠε¦­εγΒε¦ΎρφΆλυ°
```python
def zipOr(v, k):
  r = []
  for i in range(len(v)):
    r.append(v[i]|k[i])
  return r
```

# λμΏιε¥ξ·ΐθΫό
## λμΏιε¥ιιΊεΆλμΏιε¥κΐΈεΆ©νϋΈκ±Ύπ¬¤κΉ®εβΔιΆΊπ¬Ίε΅ωεβ‹

ιμΊρφΕέ[0.99,1.01]|[2,3]
-|-|-
λό€κ¦§π¬¤κΉ®|2.80e-2 γζ’ 1.19e-7 |1.19e-7
κ»³ιύ®κ¤κΉ®|2.61e-5 γζ’ 3.02e-8 |2.38e-8
- [0.99,1.01]εα®ξ΄ΎκΌ¦εαΈθΘ»ιφ¨ε΅υεβΈεΆ΅

## ρΰήηΊ¦
-|λμΏιε¥ιιΉέλμΏιε¥κΐ
-|-|-
clk|14.96|19.13
- εβΆεγ³εγ­εγΌεγ«ιϋάθΚ²n = 4εα®εα¨εαΊι΄„4clkραε΅οεαεα£εα
- νϋΈκ±Ύπ¬¤κΉ®εα§εα―εαεαΎιµ¶κ±Ύπ¬¤κΉ®εα§ινΆη―ζεαεα¨εαΊρΌ―Νogεα®ιςΈεΆ¬εα©ώΎ²εΆ±π¥Ψθ­£εαΞεΆ¬εα¨λΆΊλκάθΫύεβ¤ε΅βεβ‹

# εγ΅εγΆεγεβΆεβ―εβ»εβΉεα«εα΄ε΅ρεβ¶ε¥ώεβΉεβ―εγ¬εβΈεβΉεβΏ
## εγ«εγΌεγΞηΥώλυ°εα32εα®ιΰΊθΚ²εα§εαεα¨η ΄ιπ
- εγάε¤»εβ―εγ¬εβΈεβΉεβΏεβΔζ½Ώεα£εα¦θΏη―ζεαεβΆεβ―εβ»εβΉεβΔε΅υεαΦεΆ¬εα„
![width:800px](images/20230616-121218.png)
## εγάε¤»εβ―εγ¬εβΈεβΉεβΏεβΔζ½ΏεβΎεΆ¬εα¨η ΄ιπ°εΆ±κ¤¦ιΙμεβΔεΆΐεαήε΅μεαεα¨ε£θεα¬εΆ­μµ¨λδ

# εβΌεγ­ιμΜε¥υεγ©εβ°
## $k_i$εα«κ±ΎκΑΨε΅ωεβ¶ε¦®εβΈεβΉεβΏεβ’0εβ―εγεβΆεαε£λ
- vmovups(x|k|T_z,ptr(rax))
  - `T_z` εα―xbyakεα®π£¨π, MASM/GASεα§εα―`{z}`
- εγάε¦ΎεβΈώΎ°ε¥ηεγΚε¤«εγ«εγ°ρΌ²εΆ±εγ¬εβΈεβΉεβΏεα®θΐΪη­ΠλΜ¤θΑ¤ε΅μνωΊντήε΅ωεβ¶εΆ°εα§ραε΅οεαεβ¶ηΎ±ογ½λΰ§
- εβΌεγ­ιμΜε¥υεγ©εβ°εβΔεΆ¦εαΒε£λεα¨κ°ήκ΅Έη±νεα®xεα®ιΰ¤εα«θΐΪη­Πε΅χεαεα¨εΆ°εα§ς­Πλ€ήεΆ­ιη¦νπ¬εΆ©εαΊε£λ
## vmovups(x|k|T_z, ptr(m))
x|$x_0$|$x_1$|$x_2$|...|$x_{15}$
-|-|-|-|-|-
m|$m_0$|$m_1$|$m_2$|...|$m_{15}$
k|$k_0=1$|$k_1=0$|$k_2=0$|...|$k_{15}=1$
x|$m_0$|$0$|$0$|...|$m_{15}$


# εγ«εγΌεγΞη®¨νπ¬εΆ°μ¨¤ιΚ§(1/2)
## εγ΅εβ¤εγ³εα¨ξ­―λυ°ιη¦νπ¬εΆ­ιθ¬η²΄
- εγ΅εβ¤εγ³ιη¦νπ† : 16NώΎ――εα―εβΆεγ³εγ­εγΌεγ«ιϋάθΚ²ώΎ²ε΅ϊεα¤π¨Άι΄ εβΔη®¨νπ¬ε΅ωεβ‹
```python
  mov(rcx, n) # n εα―ρεΊη―χεα®π¨Άι΄ λυ°
  jmp(check1L)
  align(32)
  L(lpUnrollL)
  un(vmovups)(v0, ptr(src)) # 16Nιΰ¶η―ζεα®floatεβΔκ­εαΏπΐΌεβ€
  add(src, 64*unrollN)      # 64Nεγΐε¤¦εγ°η―ζsrcεβΆεγ²ε¦®εβΉεβΔλ€²εβΆε£λ
  func(unrollN, args)       # ρφΆλυ°λό¬θΏΖε£ςιρΌεα³ιηΊεα™
  un(vmovups)(ptr(dst), v0) # 16Nιΰ¶ιµΐθΫόεβΔθΦΊεαΊκΎΌεβ€
  add(dst, 64*unrollN)      # 64Nεγΐε¤¦εγ°η―ζdstεβΆεγ²ε¦®εβΉεβΔλ€²εβΆε£λ
  sub(n, 16*unrollN)        # 16Nεβ«εβ¦εγ³εβΏεβΔθΈΦε£ιεα™
  L(check1L)
  cmp(n, 16*unrollN)
  jae(lpUnrollL)             # n >= 16*Nεα®ρφΖε¦­εγΌεγ—
```
- νπ¬θ¦µεα―srcεβ’64εγΐε¤¦εγ°ε¤¤εγ©εβ¤εγ΅εγ³εγ°ε΅ωεβ¶η®¨νπ¬ε£ςιε¥εβΈε£λώΎ―Χmovupsεα§εβ¤ηΉαιθ¬λ€ήε΅δεαΒεΆ«ώΎ‰
- μµ¨λδ : εγάε¤»εβ―εγ¬εβΈεβΉεβΏεβΔζ½Ώεα¬εΆραε΅οεαεβ¶εΆ°εα§θΊΊκ¦ΆεΆ¬εα¨εαΊεΆ±θΏΏεβΎεΆ¬εα„

# εγ«εγΌεγΞη®¨νπ¬εΆ°μ¨¤ιΚ§(2/2)
## ξ­―λυ°ιη¦νπ†
- 0 < ecx < 16
```python
  and_(ecx, 15)
  jz(exitL)
  mov(eax, 1)    # eax = 1
  shl(eax, cl)   # eax = 1 << n
  sub(eax, 1)    # eax = (1 << n) - 1
  kmovd(k1, eax) # k1 = eax
  vmovups(zm0|k1|T_z, ptr(src))
  func(1, args)              # ρφΆλυ°λό¬θΏΖε£ςιρΌεα³ιηΊεα™
  vmovups(ptr(dst)|k1, zm0)
  L(exitL)
```
- `(1<<n)-1`εα§nιΰ¶εΆ°1εαΈι«¶εΆ¦εγΖε¥γεγ°ε¥ώεβΉεβ―εβΔζ½Ψε£λ
- `kmovd(k1, eax)`εα§εγάε¤»εβ―εγ¬εβΈεβΉεβΏεβΔκ¨­κ°
- `zmm0|k1|T_z`εβΔζ½Ώεα£εα¦εγ΅εγΆεγεα®π¬­εαΏλϋΈεαΊε£ςεαε£λ

# εαΎεα¨εβ
## AVX-512
- εγ¬εβΈεβΉεβΏλυ°εαΈη¤Τε΅δεα®εα§εγ«εγΌεγΞε¤¤εγ³εγ­εγΌεγ«εαΈθΧιικΉ
- εγΜε¦―εγΌεγ²ε¤―εγ£εβΉεγ°ηΒΏθ½¤εα®θ½£εβΎε£κεα«εγΜε¦―εγΌεγ²ε¤―εγ£εβΉεγ°ε¥υεγ©εβ°εα§εγ΅εγΆεγεβΆεβ―εβ»εβΉεβΔθΈΦε£ιεα™
- εγάε¤»εβ―εγ¬εβΈεβΉεβΏεβΔζ½Ώεα£εα¦ιθ¬η²ΐε£ςραΏεαΒε£λ
- AVX-512κ²¤ιΘιρ½θ½¤εβΔη°«ντ¨εαε£λ
  - λυ΄λυ°ργ¨εβ¨η°ΎθΚ²ργ¨εβΔη½φεβ΄η®Όεα™ : vrndscaleps, vreduceps
  - λμ®θΚ²ργ¨εβ¨ζ»®λυ°ργ¨εβΔη½φεβ΄η®Όεα™ : vgetexpss, vgetmantss
  - κ²Ύε΅υεα¨ε¥ζεγΌεγΜε¦­εγ«εγ¦ε¤±εβΆεγ¦ε¥χ : vpermps, vpermi2psεαεα©
